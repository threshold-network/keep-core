# Node Startup Troubleshooting

## Common Error: "operator not registered for the staking provider"

**Error Message:**
```
FATAL error initializing beacon: [could not set up sortition pool monitoring: [operator not registered for the staking provider, check Threshold dashboard]]
```

**Cause:** Operators are not properly registered in the WalletRegistry contract.

**Solution:**

### Step 1: Check Registration Status

```bash
# Check if a specific operator is registered
OPERATOR="0xef38534ea190856217cbaf454a582beb74b9e7bf"
./keep-client ethereum ecdsa wallet-registry is-operator-in-pool "$OPERATOR" \
  --config configs/config.toml \
  --developer
```

If this returns `false`, the operator needs to be registered.

### Step 2: Re-run Registration

```bash
# Re-run the registration script
./scripts/register-operators.sh

# Or register manually for a specific operator
OPERATOR="0xef38534ea190856217cbaf454a582beb74b9e7bf"
NODE_CONFIG="configs/node1.toml"

# 1. Approve tokens (if needed)
# 2. Stake tokens
./keep-client ethereum threshold token-staking stake \
  "$OPERATOR" "$OPERATOR" "$OPERATOR" 0xa968163f0a57b400000 \
  --submit --config "$NODE_CONFIG" --developer

# 3. Authorize WalletRegistry
WALLET_REGISTRY="0xbd49D2e3E501918CD08Eb4cCa34984F428c83464"
./keep-client ethereum threshold token-staking increase-authorization \
  "$OPERATOR" "$WALLET_REGISTRY" 0x878678326eac9000000 \
  --submit --config "$NODE_CONFIG" --developer

# 4. Register operator
./keep-client ethereum ecdsa wallet-registry register-operator \
  "$OPERATOR" \
  --submit --config "$NODE_CONFIG" --developer
```

### Step 3: Verify Registration

```bash
# Check again
./keep-client ethereum ecdsa wallet-registry is-operator-in-pool "$OPERATOR" \
  --config configs/config.toml \
  --developer

# Should return: true
```

### Step 4: Start Nodes

```bash
# After all operators are registered, start nodes
./configs/start-all-nodes.sh
```

## Other Common Issues

### Issue: "insufficient funds for transfer"

**Cause:** Operator account doesn't have ETH for gas.

**Solution:**
```bash
./scripts/fund-operators.sh
```

### Issue: "Transfer amount exceeds allowance"

**Cause:** T tokens not approved for TokenStaking contract.

**Solution:** The registration script should handle this automatically. If it fails:
1. Check approval step output in registration script
2. Manually approve tokens using Hardhat console (see registration script)

### Issue: Port Already in Use

**Error:** `bind: address already in use`

**Solution:**
```bash
# Stop all nodes
./configs/stop-all-nodes.sh

# Check for remaining processes
ps aux | grep keep-client

# Kill any remaining processes
pkill -f keep-client

# Try starting again
./configs/start-all-nodes.sh
```

### Issue: Config File Not Found

**Error:** `error reading config: open configs/node1.toml: no such file or directory`

**Solution:**
```bash
# Generate config files
./scripts/setup-multi-node-dkg.sh [num-nodes]
```

### Issue: Keyfile Not Found

**Error:** `error reading keyfile: open keystore/operator1.json: no such file or directory`

**Solution:**
```bash
# Keyfiles should be generated by setup-multi-node-dkg.sh
# Check if they exist
ls -la keystore/operator*/

# If missing, re-run setup
./scripts/setup-multi-node-dkg.sh [num-nodes]
```

## Complete Diagnostic Checklist

Before starting nodes, verify:

- [ ] All operators are registered: `is-operator-in-pool` returns `true`
- [ ] All operators have ETH: `./scripts/fund-operators.sh`
- [ ] All operators have T tokens staked
- [ ] All operators are authorized for WalletRegistry
- [ ] Config files exist: `ls configs/node*.toml`
- [ ] Keyfiles exist: `ls keystore/operator*/UTC*`
- [ ] Ports are available: `netstat -an | grep -E "(3919|9601|9602)"`
- [ ] Geth is running: `curl -X POST -H "Content-Type: application/json" --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' http://localhost:8545`

## Quick Fix Script

```bash
#!/bin/bash
# Quick fix for "operator not registered" error

echo "Checking operator registration..."
OPERATOR="0xef38534ea190856217cbaf454a582beb74b9e7bf"  # Replace with your operator

IS_REGISTERED=$(./keep-client ethereum ecdsa wallet-registry is-operator-in-pool "$OPERATOR" \
  --config configs/config.toml --developer 2>&1 | grep -iE "(true|false)" | head -1)

if [ "$IS_REGISTERED" != "true" ]; then
    echo "Operator not registered. Running registration..."
    ./scripts/register-operators.sh
else
    echo "Operator is registered. Checking other issues..."
fi
```

